<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>台南市公有停車場</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map-container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
        }

        #mymap {
            margin: 0;
            padding: 0px;
            width: 100%;
            height: 100%;
        }

        img.cctv {
            border: 0px;
            margin: 0;
            padding: 0;
            width: 360px;
            height: 240px;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.1.0/dist/MarkerCluster.css" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.1.0/dist/MarkerCluster.Default.css" crossorigin="" />

    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.1.0/dist/leaflet.markercluster.js" crossorigin=""></script>



    <!-- 台南市政府開放資料 -->

    <script type="text/javascript">
        function initMap() {
            var map = L.map('mymap').setView([22.991620, 120.185030], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
            }).addTo(map);

            // cluster
            var markers = L.markerClusterGroup();
            map.addLayer(markers);
            // attach parent map
            markers.parent_map = map;

            return markers;
        }

        function addCircle(map, coordinates, params) {
            var circle;
            try { // 部份資料經緯度格式異常
                circle = L.circle(coordinates, {
                    color: params.color || 'red',
                    radius: params.radius || '30'
                }).addTo(map);
            } catch (e) {
                console.log(e);
                return;
            }

            var payload = params.payload;

            circle.bindPopup(
                '<a href="http://maps.google.com/?cbll=' + coordinates[0] + ',' + coordinates[1] + '&cbp=12,20.09,,0,5&layer=c" target="_blank">' + payload['停車場名稱'] + '</a>' +
                "<br>" + (payload['收費費率'] || payload['收費標準(收費時間)'] || '') +
                ' (' + (payload['收費時間'] || payload['營業時間'] || '') + ')' + '&nbsp;' +
                "<br>" + '大' + '<b style="color:blue">' + (payload['一般大型車'] || payload['大型車'] || 0) + '</b>' + '&nbsp;' +
                '小' + '<b style="color:blue">' + (payload['一般小型車'] || payload['小型車'] || 0) + '</b>' + '&nbsp;' +
                '綠' + '<b style="color:blue">' + (payload['綠能小型車'] || 0) + '</b>' + '&nbsp;' +
                '機' + '<b style="color:blue">' + (payload['一般機車'] || payload['機車'] || 0) + '</b>' + '&nbsp;' +
                ""
            );

            return map;
        }

        function addCCTV(map, coordinates, params) {
            var circle;
            try { // 部份資料經緯度格式異常
                circle = L.circle(coordinates, {
                    color: params.color || 'red',
                    radius: params.radius || '30'
                }).addTo(map);
            } catch (e) {
                console.log(e);
                return;
            }

            var payload = params.payload;

            circle.bindPopup(
                '<a href="http://maps.google.com/?cbll=' +
                coordinates[0] + ',' + coordinates[1] + '&cbp=12,20.09,,0,5&layer=c" target="_blank">' +
                (payload['stakenumber'] || '') +
                '</a>' +
                '<br><a href="' + (payload['html'] || '') + '" target="_blank">' +
                '<img class="cctv" alt="' + (payload['stakenumber'] || '') + '" src="' + (payload['html'] || '') + '">' +
                '</a>' +
                "", {
                    maxWidth: "auto"
                }
            );

            return map;
        }

        $(document).ready(function() {
            var map = initMap();

            $(document).ajaxComplete(function() {
                map.parent_map.setView([22.991620, 120.185030], 12);
            });

            var cors_proxy = 'https://cors-anywhere.herokuapp.com/';

            // 臺南市公有免費停車場
            $.getJSON(cors_proxy + 'http://163.29.141.11/App/parking.ashx?verCode=5177E3481D&type=1&ftype=1&exportTo=2', function(data) {
                $.each(data, function(k, v) {
                    //console.log(v['經緯度']);
                    var coordinates = v['經緯度'].split('，').map(parseFloat);
                    addCircle(map, coordinates, {
                        color: 'blue',
                        payload: v
                    });
                });
            });

            // 臺南市公有收費停車場
            $.getJSON(cors_proxy + 'http://163.29.141.11/App/parking.ashx?verCode=5177E3481D&type=2&ftype=1&exportTo=2', function(data) {
                $.each(data, function(k, v) {
                    if (!v['經緯度']) {
                        console.log(v);
                        return;
                    }
                    var coordinates = v['經緯度'].split('，').map(parseFloat);
                    addCircle(map, coordinates, {
                        color: 'red',
                        payload: v
                    });
                });
            });

            // 臺南市各行政區現有認養及代管空地設置停車場明細表
            $.getJSON(cors_proxy + 'https://data.tainan.gov.tw/api/3/action/datastore_search?resource_id=b1aece34-a907-40a9-8678-f17198786571&limit=500', function(data) {
                $.each(data['result']['records'], function(k, v) {
                    if (!v['_id']) {
                        console.log(v);
                        return;
                    }
                    var coordinates = [v['緯度'] || 0, v['經度'] || 0];
                    addCircle(map, coordinates, {
                        color: 'blue',
                        payload: v
                    });
                });
            });

            // 高雄市公有路外停車場
            $.getJSON(cors_proxy + 'https://data.kcg.gov.tw/api/action/datastore_search?resource_id=fe3f93da-9673-4f7b-859c-9017d793f798&limit=500', function(data) {
                $.each(data['result']['records'], function(k, v) {
                    if (!v['_id']) {
                        console.log(v);
                        return;
                    }
                    var coordinates = [v['座標-緯度'] || 0, v['座標-經度'] || 0];
                    addCircle(map, coordinates, {
                        color: 'purple',
                        payload: v
                    });
                });
            });

            var cctv_json = [
                'https://thbapp.thb.gov.tw/services/cctv/freeway', // 國道
                'https://thbapp.thb.gov.tw/services/cctv/thb', // 省道
                'https://thbapp.thb.gov.tw/services/cctv/county' // 縣市
            ];

            // CCTVs
            for (var i = 0; i < cctv_json.length; i++) {
                $.getJSON(cctv_json[i], function(data) {
                    $.each(data, function(k, v) {
                        var coordinates = [v['gisy'] || 0, v['gisx'] || 0];
                        addCCTV(map, coordinates, {
                            color: 'green',
                            payload: v
                        });
                    });
                });
            }
        });
    </script>
</head>

<body>
    <div id="map-container">
        <div id="mymap"></div>
    </div>
</body>

</html>
